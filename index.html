<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>Mapa de Riesgo de Inundación de Puerto Rico</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- MapLibre GL JS CSS -->
    <link href="https://unpkg.com/maplibre-gl@4.3.0/dist/maplibre-gl.css" rel="stylesheet" />

    <style>
        /* Base Styles & Accessibility */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Open Sans', 'Helvetica Neue', Arial, Helvetica, sans-serif;
            color: #333;
            overflow: hidden;
        }

        /* Header / Banner */
        #app-header {
            background-color: #004d99;
            color: #fff;
            padding: 15px 20px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            position: relative;
            z-index: 10;
        }
        #app-header h1 {
            margin: 0;
            font-size: 1.8em;
            margin-bottom: 5px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        #app-header p {
            margin: 0;
            font-size: 1em;
            opacity: 0.9;
        }

        /* Search Bar Container */
        .search-container {
            position: absolute;
            top: calc(100px + 10px); /* Header height + some margin */
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            width: 90%;
            max-width: 400px; /* Limit width on desktop */
            background: rgba(255, 255, 255, 0.95);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            display: flex; /* For input and button side-by-side */
            gap: 10px;
            align-items: center;
        }
        .search-container input[type="text"] {
            flex-grow: 1; /* Input takes available space */
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1em;
            outline: none;
        }
        .search-container input[type="text"]:focus {
            border-color: #004d99;
            box-shadow: 0 0 0 2px rgba(0, 77, 153, 0.2);
        }
        .search-container button {
            padding: 8px 15px;
            background-color: #004d99;
            color: #fff;
            border: none;
            border-radius: 4px;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .search-container button:hover {
            background-color: #003366;
        }
        .search-container .search-status {
            font-size: 0.8em;
            color: #e61d00;
            margin-top: 5px;
            text-align: center;
            width: 100%;
        }


        /* Map Container */
        #map {
            position: absolute;
            top: 100px;
            bottom: 0;
            width: 100%;
        }

        /* Map Overlay / Legend */
        .map-overlay {
            font-size: 0.9em;
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.4);
            z-index: 5;
            max-width: 280px;
        }
        .map-overlay h3 {
            margin: 0 0 10px;
            font-size: 1.15em;
            color: #004d99;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        .map-overlay .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        .map-overlay .color-box {
            width: 25px;
            height: 20px;
            margin-right: 12px;
            border: 1px solid rgba(0, 0, 0, 0.2);
            flex-shrink: 0;
            border-radius: 3px;
        }
        .map-overlay .attribution {
            font-size: 0.75em;
            margin-top: 15px;
            border-top: 1px solid #eee;
            padding-top: 10px;
            color: #666;
        }

        /* Responsive Adjustments (Mobile-First Approach) */

        /* General adjustments for smaller screens (up to tablets) */
        @media (max-width: 768px) {
            #app-header {
                padding: 12px 15px;
            }
            #app-header h1 {
                font-size: 1.6em;
            }
            #app-header p {
                font-size: 0.9em;
            }
            #map {
                top: 85px;
            }
            .search-container {
                top: calc(85px + 10px);
                width: calc(100% - 40px); /* Accounting for 20px padding on each side */
                left: 20px; /* Align to left */
                transform: translateX(0); /* Remove transform */
                max-width: none; /* Remove max-width */
                padding: 8px;
                gap: 8px;
            }
            .search-container input, .search-container button {
                font-size: 0.9em;
                padding: 6px 10px;
            }
            .map-overlay {
                left: 10px;
                bottom: 10px;
                right: 10px;
                max-width: calc(100% - 20px);
                font-size: 0.85em;
                padding: 12px;
                box-shadow: 0 1px 5px rgba(0, 0, 0, 0.3);
            }
            .map-overlay .color-box {
                width: 20px;
                height: 16px;
                margin-right: 10px;
            }

            /* NEW: Hide MapLibre GL JS navigation controls on smaller screens */
            .maplibregl-ctrl-group.maplibregl-ctrl-top-right {
                display: none !important; /* Use !important to override default inline styles */
            }
        }

        /* Adjustments for very small screens (smartphones) */
        @media (max-width: 480px) {
            #app-header {
                padding: 10px 10px;
            }
            #app-header h1 {
                font-size: 1.4em;
            }
            #app-header p {
                font-size: 0.8em;
            }
            #map {
                top: 75px;
            }
            .search-container {
                top: calc(75px + 8px); /* Adjust based on new header height */
                padding: 6px;
                gap: 6px;
            }
            .search-container input, .search-container button {
                font-size: 0.8em;
                padding: 5px 8px;
            }
            .map-overlay {
                bottom: 5px;
                left: 5px;
                right: 5px;
                max-width: calc(100% - 10px);
                font-size: 0.75em;
                padding: 10px;
            }
            .map-overlay h3 {
                font-size: 1em;
            }
            .map-overlay .color-box {
                width: 18px;
                height: 14px;
                margin-right: 8px;
            }
            .map-overlay .legend-item {
                margin-bottom: 5px;
            }
            .search-container .search-status {
                font-size: 0.7em;
            }
        }
    </style>
</head>
<body>
    <header id="app-header" role="banner">
        <h1>Mapa de Riesgo de Inundación de Puerto Rico</h1>
        <p>Identifica áreas propensas a inundaciones para tu seguridad y preparación.</p>
    </header>

    <div class="search-container">
        <label for="search-input" class="sr-only">Buscar lugar</label>
        <input type="text" id="search-input" placeholder="Ej: Condominio Plaza del Parque, Caguas" aria-label="Introduce el nombre de un lugar o dirección para buscar en el mapa">
        <button id="search-button">Buscar</button>
        <div id="search-status" class="search-status" role="status" aria-live="polite"></div>
    </div>

    <div id="map" role="application" aria-label="Mapa interactivo de zonas de riesgo de inundación"></div>

    <!-- Legend Overlay -->
    <div class="map-overlay" role="complementary" aria-labelledby="legend-heading">
        <h3 id="legend-heading">Riesgo de Inundación</h3>
        <div class="legend-item">
            <div class="color-box" style="background-color: #e61d00;"></div>
            <span>Alto Riesgo (SFHA - 1% Probabilidad Anual)</span>
        </div>
        <div class="legend-item">
            <div class="color-box" style="background-color: #ffaa00;"></div>
            <span>Riesgo Moderado (0.2% Probabilidad Anual)</span>
        </div>
        <div class="legend-item">
            <div class="color-box" style="background-color: #66ccff; opacity: 0.2;"></div>
            <span>Riesgo Mínimo (Fuera de la Llanura de Inundación)</span>
        </div>
        <div class="legend-item">
            <div class="color-box" style="background-color: #808080;"></div>
            <span>Peligro Indeterminado</span>
        </div>
        <div class="attribution">
            Datos: FEMA NFHL (2021), <a href="https://www.openstreetmap.org/copyright" target="_blank">OpenStreetMap</a>
        </div>
    </div>


    <!-- MapLibre GL JS Library -->
    <script src="https://unpkg.com/maplibre-gl@4.3.0/dist/maplibre-gl.js"></script>

    <script>
        // Adjust map top position based on header height for better responsiveness
        function adjustMapTop() {
            const headerHeight = document.getElementById('app-header').offsetHeight;
            document.getElementById('map').style.top = headerHeight + 'px';
            // Also adjust search bar top based on header height
            const searchContainer = document.querySelector('.search-container');
            if (searchContainer) {
                searchContainer.style.top = (headerHeight + 10) + 'px'; // 10px margin below header
            }
        }

        window.addEventListener('load', adjustMapTop);
        window.addEventListener('resize', adjustMapTop);

        const map = new maplibregl.Map({
            container: 'map', // container ID
            style: {
                version: 8,
                sources: {
                    osm: {
                        type: 'raster',
                        tiles: [
                            'https://a.tile.openstreetmap.org/{z}/{x}/{y}.png',
                            'https://b.tile.openstreetmap.org/{z}/{x}/{y}.png',
                            'https://c.tile.openstreetmap.org/{z}/{x}/{y}.png'
                        ],
                        tileSize: 256,
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contribuidores'
                    }
                },
                layers: [
                    {
                        id: 'osm-tiles',
                        type: 'raster',
                        source: 'osm',
                        minzoom: 0,
                        maxzoom: 19
                    }
                ]
            },
            center: [-66.5901, 18.2208], // starting position [lng, lat] for Puerto Rico
            zoom: 9 // starting zoom
        });

        // KEEP: MapLibre GL JS navigation controls are added to 'top-right'
        map.addControl(new maplibregl.NavigationControl(), 'top-right');

        // Add scale control (can keep its default bottom-left if desired, or move)
        map.addControl(new maplibregl.ScaleControl());

        // Marker for search results
        let searchResultMarker = null;

        // Search functionality
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        const searchStatus = document.getElementById('search-status');

        searchButton.addEventListener('click', performSearch);
        searchInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                performSearch();
            }
        });

        async function performSearch() {
            const query = searchInput.value.trim();
            if (!query) {
                searchStatus.textContent = 'Por favor, introduce un lugar.';
                return;
            }

            searchStatus.textContent = 'Buscando...';
            // Construct Nominatim API URL (with 'Puerto Rico' added for better results)
            const bboxPR = '-67.3,-67.9,17.9,18.5'; // Approx bounds: min_lon,min_lat,max_lon,max_lat
            const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}, Puerto Rico&format=json&limit=1&bounded=1&viewbox=${bboxPR}`;

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                if (data && data.length > 0) {
                    const result = data[0];
                    const lat = parseFloat(result.lat);
                    const lon = parseFloat(result.lon);

                    searchStatus.textContent = `Encontrado: ${result.display_name}`;

                    // Fly to the location
                    map.flyTo({
                        center: [lon, lat],
                        zoom: 15, // Zoom in closer
                        essential: true
                    });

                    // Add/move marker
                    if (searchResultMarker) {
                        searchResultMarker.setLngLat([lon, lat]);
                    } else {
                        searchResultMarker = new maplibregl.Marker({ color: '#004d99' })
                            .setLngLat([lon, lat])
                            .addTo(map);
                    }
                    searchResultMarker.setPopup(new maplibregl.Popup().setHTML(`<b>${result.display_name}</b>`));
                    searchResultMarker.getPopup().addTo(map);

                } else {
                    searchStatus.textContent = 'No se encontraron resultados. Intenta con un nombre más específico o diferente.';
                    if (searchResultMarker) {
                        searchResultMarker.remove();
                        searchResultMarker = null;
                    }
                }
            } catch (error) {
                searchStatus.textContent = `Error en la búsqueda: ${error.message}`;
                console.error('Geocoding error:', error);
            }
        }

        map.on('load', () => {
            // 1. Add Puerto Rico Municipality GeoJSON
            map.addSource('municipalities', {
                type: 'geojson',
                data: 'data/puerto_rico_municipalities.geojson'
            });

            map.addLayer({
                id: 'municipalities-layer',
                type: 'fill',
                source: 'municipalities',
                layout: {},
                paint: {
                    'fill-color': '#ccc',
                    'fill-opacity': 0.1
                }
            });
            map.addLayer({
                id: 'municipalities-borders',
                type: 'line',
                source: 'municipalities',
                layout: {},
                paint: {
                    'line-color': '#000',
                    'line-width': 1
                }
            });

            map.on('click', 'municipalities-layer', (e) => {
                const properties = e.features[0].properties;
                new maplibregl.Popup()
                    .setLngLat(e.lngLat)
                    .setHTML(`<b>${properties.NAME_OF_MUNICIPALITY || 'Municipio'}</b>`)
                    .addTo(map);
            });

            map.on('mouseenter', 'municipalities-layer', () => {
                map.getCanvas().style.cursor = 'pointer';
            });
            map.on('mouseleave', 'municipalities-layer', () => {
                map.getCanvas().style.cursor = '';
            });


            // 2. Add Flood Zone GeoJSON with Data-Driven Styling
            map.addSource('flood-zones', {
                type: 'geojson',
                data: 'data/puerto_rico_flood_hazards_simplified.geojson' // Path to your converted FEMA GeoJSON
            });

            map.addLayer({
                id: 'flood-zones-fill',
                type: 'fill',
                source: 'flood-zones',
                paint: {
                    'fill-color': [
                        'match',
                        ['get', 'FLD_ZONE'],
                        ['A', 'AE', 'AH', 'AO', 'AR', 'A99', 'V', 'VE'], '#e61d00', // Alto Riesgo (Rojo)
                        ['X', 'X500'], '#ffaa00', // Riesgo Moderado (Naranja)
                        ['D'], '#808080', // Peligro Indeterminado (Gris)
                        '#66ccff' // Riesgo Mínimo (Azul claro, para X sin sombra)
                    ],
                    'fill-opacity': [
                        'match',
                        ['get', 'FLD_ZONE'],
                        ['A', 'AE', 'AH', 'AO', 'AR', 'A99', 'V', 'VE'], 0.6,
                        ['X', 'X500'], 0.4,
                        ['D'], 0.4,
                        0.2 // Minimal risk areas can be very light
                    ]
                }
            });

            map.addLayer({
                id: 'flood-zones-borders',
                type: 'line',
                source: 'flood-zones',
                paint: {
                    'line-color': [
                        'match',
                        ['get', 'FLD_ZONE'],
                        ['A', 'AE', 'AH', 'AO', 'AR', 'A99', 'V', 'VE'], '#990000', // Rojo más oscuro
                        ['X', 'X500'], '#cc8800', // Naranja más oscuro
                        ['D'], '#555555', // Gris más oscuro
                        '#006699' // Azul más oscuro
                    ],
                    'line-width': 1.5,
                    'line-opacity': 0.8
                }
            });

            map.on('click', 'flood-zones-fill', (e) => {
                const properties = e.features[0].properties;
                const sfhaText = properties.SFHA_TF === 'T' ? 'Sí (Área Especial de Riesgo de Inundación)' : (properties.SFHA_TF === 'F' ? 'No (Fuera de SFHA)' : 'N/A');
                new maplibregl.Popup()
                    .setLngLat(e.lngLat)
                    .setHTML(`
                        <b>Zona de Inundación:</b> ${properties.FLD_ZONE || 'N/A'}<br>
                        <b>Subtipo de Zona:</b> ${properties.ZONE_SUBTY || 'N/A'}<br>
                        <b>SFHA:</b> ${sfhaText}
                    `)
                    .addTo(map);
            });

            map.on('mouseenter', 'flood-zones-fill', () => {
                map.getCanvas().style.cursor = 'pointer';
            });
            map.on('mouseleave', 'flood-zones-fill', () => {
                map.getCanvas().style.cursor = '';
            });
        });
    </script>
</body>
</html>